---
title: "csss_historic"
author: "Kyle Furlong"
date: "6/19/2019"
output: html_document
---

```{r}
library(DiagrammeR)
library(dplyr)
library(tidyr)
library(ggplot2)

theme_set(theme_bw())
```

```{r read_data}
all <- read.csv("data/csss-all.csv")
dakota <- read.csv("data/csss-dakota.csv")
emily <- read.csv("data/csss-emily.csv")
fabian <- read.csv("data/csss-fabian.csv")
jackie <- read.csv("data/csss-jackie.csv")
kyle <- read.csv("data/csss-kyle.csv")

```


```{r}
generate_csss_network_df <- function(df, iter){
  partic.df <- df %>%
    filter(iteration == as.factor(iter)) %>%
    select(Name:Location) %>%
    unique() %>%
    mutate(
      Name = as.factor(Name),
      name.id = as.numeric(droplevels(Name)))
  
  edge.df.temp <- df %>%
    filter(iteration == iter) %>%
    select(Title, name1 = Name, Year) %>%
    left_join(df, by = c("Title", "Year")) %>%
    filter(name1 != Name) %>%
    select(Title, name1, name2 = Name, Topic, Topic_isced, Year) %>%
    arrange(name1) %>%
    mutate(name1 = as.factor(name1),
           name2 = as.factor(name2),
           name.id1 = as.numeric(droplevels(name1)),
           name.id2 = as.numeric(droplevels(name2)),
           name.link = paste(name.id1, name.id2, sep = "_"))
  
  edge.df <- edge.df.temp %>%
    select(name.id1, name.id2) %>%
    mutate(name.link = ifelse(name.id1<name.id2, paste(name.id1, name.id2, sep = "_"), paste(name.id2, name.id1, sep = "_"))) %>%
    select(name.link) %>%
    unique() %>%
    left_join(edge.df.temp, by = "name.link")
  
  nodes.df <- create_node_df(
    n = nrow(partic.df),
    nodes = partic.df$name.id,
    label = partic.df$Name,
    color = "red", 
    year = iter, 
    discp = partic.df$Discipline_isced, 
    nat = partic.df$Nationality, 
    pos = partic.df$Position, 
    cntry = partic.df$Country_University 
  )
  
  edges.df <- create_edge_df(
    from = edge.df$name.id1,
    to = edge.df$name.id2,
    dir = rep("none", length(edge.df$name.id1)))
  
  graph <- create_graph(nodes_df = nodes.df, 
                        edges_df = edges.df)
  
  return(graph)
}

graph_network <- function(graph_code) {
  render_graph(graph_code)
}

```

```{r fig.height= 12, fig.width= 12}

generate_all_graphs <- function(df) {
  data.list <- list()
  for(i in 1:length(unique(df$iteration))) {
    data.list[[i]] <- generate_csss_network_df(df, iter = unique(df$iteration)[i])
  }
  return(data.list)
}

all.graphs <- generate_all_graphs(all)

```

```{r graph_functions}
#averages for entire network by year
graph_measures <- function(graph) {
  df <- data.frame(graph = get_node_df(graph)$year[1],
                   avg_degree = NA, 
                   max_ecct = NA, 
                   avg_btwn = NA, 
                   avg_path = NA, 
                   avg_const = NA)
  df$avg_degree <- get_agg_degree_total(graph, "mean")
  df$max_ecct <- get_max_eccentricity(graph)
  df$avg_btwn <- mean(get_betweenness(graph)$betweenness)
  df$avg_path <- get_mean_distance(graph)
  df$avg_const <- mean(get_constraint(graph)$constraint)
  return(df)
}

yearly_compare <- function(graphs) {
  compile <- graph_measures(graphs[[1]])
  for(i in 2:length(all.graphs)) {
    compile[nrow(compile) + 1,] <- graph_measures(graphs[[i]])
  }
  return(compile)
}
yearly.compare <- yearly_compare(all.graphs)

avdg <- ggplot(data = yearly.compare) +
  geom_col(mapping = aes(x = graph, y = avg_degree)) +
  coord_flip() +
  labs(y = "Average Degree", x = "Year and Location")

diam <- ggplot(data = yearly.compare) +
  geom_col(mapping = aes(x = graph, y = max_ecct)) +
  coord_flip() +
  labs(y = "Diameter", x = "Year and Location")

path <- ggplot(data = yearly.compare) +
  geom_col(mapping = aes(x = graph, y = avg_path)) +
  coord_flip() +
  labs(y = "Average Path Length", x = "Year and Location")

cons <- ggplot(data = yearly.compare) +
  geom_col(mapping = aes(x = graph, y = avg_const)) +
  coord_flip() +
  labs(y = "Average Constraint", x = "Year and Location")

cowplot::plot_grid(avdg, diam, path, cons)

#degree distribution
palette <- palette(rainbow(17))
dd.plot <- ggplot()
for(i in 1:length(all.graphs)) {
  dd.plot <- dd.plot + geom_line(get_degree_distribution(all.graphs[[i]]), mapping = aes(x = degree, y = total_degree_dist))
}
plot(dd.plot)

##need to do degree distribution comparison

```

```{r community_detection_functions}
#community detection comparison
compare_communities <- function(graph) {
  gn.com <- get_cmty_edge_btwns(graph)
  wt.com <- get_cmty_walktrap(graph)
  
  return(cor(gn.com$edge_btwns_group, wt.com$walktrap_group))
}

create_group_graph <- function(graph, detection = "gn") {
  groups <- get_node_df(graph)
  if(detection == "gn") {
    groups <- left_join(groups, get_cmty_edge_btwns(graph), by = "id")
  } else {
    groups <- left_join(groups, get_cmty_walktrap(graph), by = "id")
  }
  if(!require(RColorBrewer)) {install.packages("RColorBrewer")}
  
  palette <- palette(rainbow(length(unique(groups[,ncol(groups)]))))
  groups$color <- palette[groups[,ncol(groups)]]
  
  render_graph(create_graph(groups, get_edge_df(graph))) %>%
    print()
}

```

```{r node_based_analysis}
#node-measures
node_measures <- function(graph) {
  nodes <- get_node_df(graph)
  results <- nodes %>%
    left_join(get_degree_total(graph), by = "id") %>%
    left_join(get_betweenness(graph), by = "id") %>%
    left_join(get_closeness(graph), by = "id") %>%
    left_join(get_eigen_centrality(graph), by = "id") %>%
    left_join(get_constraint(graph), by = "id")
  
  #get homophily -- needs to be updated
  edges <- get_edge_df(graph)
  for(i in unique(nodes$id)) {
    cur.edges <- edges[edges$from == i,]
    cur.edges <- cur.edges %>%
      left_join(nodes, by = "id")
    
    discp.shares <- as.data.frame(table(cur.edges$discp))[as.data.frame(table(cur.edges$discp))$Freq != 0, ]
    discp.shares$prop <- discp.shares$Freq/sum(discp.shares$Freq)
    results$discp_hmph <- hhi(discp.shares, "prop")
    
    pos.shares <- as.data.frame(table(cur.edges$pos))[as.data.frame(table(cur.edges$pos))$Freq != 0, ]
    pos.shares$prop <- pos.shares$Freq/sum(pos.shares$Freq)
    results$pos_hmph <- hhi(pos.shares, "prop")
    
    cntry.shares <- as.data.frame(table(cur.edges$cntry))[as.data.frame(table(cur.edges$cntry))$Freq != 0, ]
    cntry.shares$prop <- cntry.shares$Freq/sum(cntry.shares$Freq)
    results$cntry_hmph <- hhi(cntry.shares, "prop")
  }
  
  return(results)
}

node.data <- node_measures(all.graphs[[12]])

#attempting to get homophily measures
require(hhi)
nodes <- get_node_df(all.graphs[[12]])
edges <- get_edge_df(all.graphs[[12]])

cur.edges <- edges[edges$from == 1, ]
cur.edges <- cur.edges %>%
  left_join(nodes, by = "id")

cal.shares <- as.data.frame(table(cur.edges$discp))[as.data.frame(table(cur.edges$discp))$Freq != 0, ]
cal.shares$prop <- cal.shares$Freq/sum(cal.shares$Freq)
discp.hmphly <- hhi(cal.shares, "prop")


```






